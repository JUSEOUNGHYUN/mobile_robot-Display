from PySide6.QtWidgets import QWidget, QLabel, QPushButton, QVBoxLayout, QHBoxLayout, QGridLayout, QGraphicsDropShadowEffect
from PySide6.QtGui import QPixmap, QFont, QIcon, QColor
from PySide6.QtCore import Qt, Signal, QTimer, QSize
from PySide6.QtUiTools import QUiLoader
from views.StatusBar import StatusBar, StatusBarType
from Utils.MessageBox import MessageBox
from Utils.ButtonStyle import RoundButtonStyle
import os

# ë²„íŠ¼ ë””ìì¸ í´ë˜ìŠ¤
class LocationButton(QPushButton):
    """ìœ„ì¹˜ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸
    
    ëª©ì ì§€ ì„ íƒ í™”ë©´ì—ì„œ ì‚¬ìš©ë˜ëŠ” ìœ„ì¹˜ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
    """
    
    long_press_started = Signal(object)  # ë¡±í”„ë ˆìŠ¤ ì‹œì‘ ì‹œê·¸ë„ (ë²„íŠ¼ ê°ì²´ ì „ë‹¬)
    
    def __init__(self, text, location_data=None, width=230, height=130):
        """
        Args:
            text (str): ë²„íŠ¼ì— í‘œì‹œí•  í…ìŠ¤íŠ¸
            location_data (dict): ìœ„ì¹˜ ë°ì´í„°
            width (int): ë²„íŠ¼ ë„ˆë¹„
            height (int): ë²„íŠ¼ ë†’ì´
        """
        super().__init__(text)
        self.location_data = location_data
        
        # ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
        font_size = RoundButtonStyle.apply_font_by_size(self, width)
        RoundButtonStyle.apply_round_style(self, width, height, font_size)
        
        # ì„ íƒ ìŠ¤íƒ€ì¼ ì €ì¥
        self.normal_style = self.styleSheet()
        self.selected_style = RoundButtonStyle.get_selected_style()
        
    # ë²„íŠ¼ ì„ íƒ ìƒíƒœ ì„¤ì • / selected (bool): ì„ íƒ ì—¬ë¶€
    def set_selected(self, selected=True):
        if selected:
            self.setStyleSheet(self.selected_style)
        else:
            self.setStyleSheet(self.normal_style)
    
    # ìœ„ì¹˜ ë°ì´í„° ë°˜í™˜ / dict: ìœ„ì¹˜ ë°ì´í„°
    def get_location_data(self):
        return self.location_data

class LocationSelectionView(QWidget):
    # ì‹œê·¸ë„ ì •ì˜
    add_location_signal = Signal()  # ëª©ì ì§€ ì¶”ê°€ ì‹œê·¸ë„ (íŒŒë¼ë¯¸í„° ì—†ìŒ)
    edit_location_signal = Signal(dict)  # ëª©ì ì§€ ìˆ˜ì • ì‹œê·¸ë„
    start_moving_signal = Signal(dict)   # ì¶œë°œ ì‹œê·¸ë„
    delete_location_signal = Signal(dict)  # ì‚­ì œ ì‹œê·¸ë„ ì¶”ê°€
    location_selected_signal = Signal(dict)  # ìœ„ì¹˜ ì„ íƒ ì‹œê·¸ë„ ì¶”ê°€
    confirm_delete_signal = Signal(dict)  # ì‚­ì œ í™•ì¸ ì‹œê·¸ë„ ì¶”ê°€
    change_layout_signal = Signal()  # ë ˆì´ì•„ì›ƒ ë³€ê²½ ì‹œê·¸ë„ ì¶”ê°€

    def __init__(self, parent=None):
        super().__init__(parent)
        
        # UI íŒŒì¼ ë¡œë“œ
        loader = QUiLoader()
        ui_file_path = os.path.join(os.path.dirname(__file__), "..", "UI", "LocationSelectionView.ui")
        self.ui = loader.load(ui_file_path)
        
        # ë©”ì¸ ë ˆì´ì•„ì›ƒ ì„¤ì •
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # ìƒíƒœë°” ì¶”ê°€
        self.status_bar = StatusBar(self, StatusBarType.FULL)
        layout.addWidget(self.status_bar)
        
        # UI íŒŒì¼ì—ì„œ ë¡œë“œí•œ ìœ„ì ¯ ì¶”ê°€
        layout.addWidget(self.ui)
        
        # UI ìš”ì†Œ ì—°ê²°
        self.title_label = self.ui.findChild(QLabel, "title_label")
        self.grid_layout = self.ui.findChild(QGridLayout, "grid_layout")
        self.delete_button = self.ui.findChild(QPushButton, "delete_button")
        self.start_button = self.ui.findChild(QPushButton, "start_button")
        self.change_layout_button = self.ui.findChild(QPushButton, "change_layout_button")
        
        # ë²„íŠ¼ë“¤ì— ìŠ¤íƒ€ì¼ ì ìš©
        # ëª©ì ì§€ ì‚­ì œ ë²„íŠ¼ì— ìŠ¤íƒ€ì¼ ì ìš©
        RoundButtonStyle.apply_icon_button_style(
            self.delete_button, 
            width=100, 
            height=100, 
            icon_path=":/file/RegistSelect/delete_destination.png",
            icon_size=80
        )
        
        # ëª©ì ì§€ ì¶œë°œ ë²„íŠ¼ì— ìŠ¤íƒ€ì¼ ì ìš©
        RoundButtonStyle.apply_icon_button_style(
            self.start_button, 
            width=100, 
            height=100, 
            icon_path=":/file/RegistSelect/start_destination.png",
            icon_size=80
        )
        
        
        # ë ˆì´ì•„ì›ƒ ë³€ê²½ ë²„íŠ¼ì— ìŠ¤íƒ€ì¼ ì ìš©
        RoundButtonStyle.apply_icon_button_style(
            self.change_layout_button, 
            width=80, 
            height=80, 
            icon_path=":/file/RegistSelect/button_layout.png",
            icon_size=60
        )
        
        # ë²„íŠ¼ ì‹œê·¸ë„ ì—°ê²°
        self.delete_button.clicked.connect(self.on_delete_button_clicked)
        self.delete_button.pressed.connect(self.on_delete_button_clicked)  # í„°ì¹˜ìŠ¤í¬ë¦°ìš© ì´ë²¤íŠ¸ ì¶”ê°€
        self.start_button.clicked.connect(self.on_start_button_clicked)
        self.start_button.pressed.connect(self.on_start_button_clicked)  # í„°ì¹˜ìŠ¤í¬ë¦°ìš© ì´ë²¤íŠ¸ ì¶”ê°€
        self.change_layout_button.clicked.connect(self.on_change_layout_button_clicked)
        
        # ğŸ”¹ 1. í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ì„ ë‹´ì„ ì»¨í…Œì´ë„ˆ ìƒì„±
        self.plus_button_container = QWidget()
        self.plus_button_container.setFixedSize(70, 70)  # ì»¨í…Œì´ë„ˆ í¬ê¸°ëŠ” ë²„íŠ¼ë³´ë‹¤ ì•½ê°„ í¬ê²Œ
        
        # ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì ìš© - ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¶”ê°€
        self.plus_button_container.setStyleSheet("""
            QWidget {
                border-radius: 35px;
                background-color: transparent;
            }
        """)
        
        # ì»¨í…Œì´ë„ˆ ë ˆì´ì•„ì›ƒ ì„¤ì •
        container_layout = QVBoxLayout(self.plus_button_container)
        container_layout.setContentsMargins(5, 5, 5, 5)  # ì—¬ë°± ì„¤ì •
        container_layout.setAlignment(Qt.AlignCenter)
        
        # ë²„íŠ¼ ìƒì„± ë° ì´ë¯¸ì§€ ì„¤ì •
        self.plus_button = QPushButton()
        self.plus_button.setIcon(QIcon(":/file/RegistSelect/add_destination.png"))
        self.plus_button.setIconSize(QSize(120, 120))
        self.plus_button.setFixedSize(60, 60)
        
        # ë²„íŠ¼ ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì ìš©
        self.plus_button.setStyleSheet("""
            QPushButton {
                background-color: #FFFFFF;
                border-radius: 30px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #E0E0E0;
            }
        """)
        
        # ì»¨í…Œì´ë„ˆì— ë²„íŠ¼ ì¶”ê°€
        container_layout.addWidget(self.plus_button)
        
        # ê·¸ë¦¼ì íš¨ê³¼ë¥¼ ì»¨í…Œì´ë„ˆì— ì ìš©
        shadow = QGraphicsDropShadowEffect(self.plus_button_container)
        shadow.setBlurRadius(15)  # ë¸”ëŸ¬ ë°˜ê²½ ì„¤ì •
        shadow.setColor(QColor(0, 0, 0, 80))  # ê·¸ë¦¼ì ìƒ‰ìƒ ë° íˆ¬ëª…ë„
        shadow.setOffset(3, 3)  # ê·¸ë¦¼ì ì˜¤í”„ì…‹
        self.plus_button_container.setGraphicsEffect(shadow)

        self.plus_button.clicked.connect(self.add_location)
        self.plus_button.pressed.connect(self.add_location)  # í„°ì¹˜ìŠ¤í¬ë¦°ìš© ì´ë²¤íŠ¸ ì¶”ê°€
        
        # ë²„íŠ¼ ë”•ì…”ë„ˆë¦¬ (ë²„íŠ¼ê³¼ ë°ì´í„° ë§¤í•‘)
        self.location_buttons = {}
        self.location_buttons[self.plus_button] = None
        
        # ë¡±í”„ë ˆìŠ¤ íƒ€ì´ë¨¸ ì„¤ì •
        self.long_press_timer = QTimer()
        self.long_press_timer.setInterval(900)  # 0.9ì´ˆ ëŒ€ê¸°
        self.long_press_timer.setSingleShot(True)
        self.long_press_timer.timeout.connect(self.on_long_press)
        
        # ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
        self.selected_location = None
        self.current_button = None
        self.ignore_next_click = False

    def update_locations(self, locations):
        """ìœ„ì¹˜ ëª©ë¡ ì—…ë°ì´íŠ¸"""
        self.locations = locations or []
        self.setup_location_buttons()

        # ì„ íƒëœ ìœ„ì¹˜ ë° ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
        self.selected_location = None
        self.delete_button.setEnabled(False)
        self.start_button.setEnabled(False)

        # íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        if not self.locations:
            self.title_label.setText("ëª©ì ì§€ ë“±ë¡")
        else:
            self.title_label.setText("ëª©ì ì§€ ì„ íƒ")

    def setup_location_buttons(self):
        # ê¸°ì¡´ ë²„íŠ¼ ì œê±°
        for button in self.location_buttons.keys():
            if button != self.plus_button:  # + ë²„íŠ¼ì€ ìœ ì§€
                self.grid_layout.removeWidget(button)
                button.deleteLater()

        self.location_buttons = {}
        self.location_buttons[self.plus_button] = None

        # ëª©ì ì§€ ê°œìˆ˜ì— ë”°ë¼ ê·¸ë¦¬ë“œ ì„¤ì • (ìœ ë™ì  ë ˆì´ì•„ì›ƒ)
        total_locations = len(self.locations)
        
        # ê·¸ë¦¬ë“œ í¬ê¸° ê³„ì‚° (+ ë²„íŠ¼ì„ ìœ„í•œ ê³µê°„ í™•ë³´)
        if total_locations <= 3:
            max_cols = total_locations + 1  # +ë²„íŠ¼ì„ ìœ„í•œ ê³µê°„ ì¶”ê°€
            max_rows = 1
        elif total_locations <= 7:
            max_cols = 4
            max_rows = 2
        else:
            # 7ê°œ ì´ˆê³¼ ì‹œ ì—´ ìˆ˜ë¥¼ ì¡°ì ˆí•˜ì—¬ 3í–‰ ì´ìƒìœ¼ë¡œ í‘œì‹œ
            max_cols = 4
            max_rows = (total_locations + 4) // 4  # ì˜¬ë¦¼ ë‚˜ëˆ—ì…ˆ (+ë²„íŠ¼ ê³µê°„ í¬í•¨)
            
        print(f"ë ˆì´ì•„ì›ƒ ì„¤ì •: {max_rows}í–‰ x {max_cols}ì—´, ì´ {total_locations}ê°œ ëª©ì ì§€ + ì¶”ê°€ë²„íŠ¼")

        # ë²„íŠ¼ í¬ê¸°ë¥¼ ëª©ì ì§€ ê°œìˆ˜ì— ë”°ë¼ ì¡°ì ˆ
        if total_locations <= 3:
            # ëª©ì ì§€ê°€ ì ì„ ë•Œ í° ë²„íŠ¼
            button_width = 230
            button_height = 180
        elif total_locations <= 7:
            # ëª©ì ì§€ê°€ ì¤‘ê°„ ì •ë„ì¼ ë•Œ ì¤‘ê°„ í¬ê¸° ë²„íŠ¼
            button_width = 200
            button_height = 150
        else:
            # ëª©ì ì§€ê°€ ë§ì„ ë•Œ ì‘ì€ ë²„íŠ¼
            button_width = 180
            button_height = 120
        
        # +ë²„íŠ¼ í¬ê¸° ë° í°íŠ¸ í¬ê¸° ì—…ë°ì´íŠ¸
        self.plus_button.setFixedSize(button_width, button_height)
        self.plus_button_container.setFixedSize(button_width + 10, button_height + 10)
        
        # í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ì— ìŠ¤íƒ€ì¼ ì ìš©
        RoundButtonStyle.apply_round_style(self.plus_button, button_width, button_height, 45)
        
        # ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì—…ë°ì´íŠ¸ - ê³ ì • ë‘¥ê·¼ ëª¨ì„œë¦¬ ì ìš©
        self.plus_button_container.setStyleSheet("""
            QWidget {
                border-radius: 30px;
                background-color: transparent;
            }
        """)
        
        # ê·¸ë¦¼ì íš¨ê³¼ë¥¼ ì»¨í…Œì´ë„ˆì— ì ìš©
        shadow = QGraphicsDropShadowEffect(self.plus_button_container)
        shadow.setBlurRadius(15)  # ë¸”ëŸ¬ ë°˜ê²½ ì„¤ì •
        shadow.setColor(QColor(0, 0, 0, 80))  # ê·¸ë¦¼ì ìƒ‰ìƒ ë° íˆ¬ëª…ë„
        shadow.setOffset(3, 3)  # ê·¸ë¦¼ì ì˜¤í”„ì…‹
        self.plus_button_container.setGraphicsEffect(shadow)

        # ëª©ì ì§€ ë²„íŠ¼ ìƒì„± ë° ë°°ì¹˜
        for i, location in enumerate(self.locations):
            # ìœ„ì¹˜ ê³„ì‚°
            row = i // max_cols
            col = i % max_cols

            # ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
            if isinstance(location, dict) and 'name' in location:
                button_text = location['name']
            else:
                button_text = str(location)

            # ë²„íŠ¼ ìƒì„± - ê°œìˆ˜ì— ë”°ë¥¸ í¬ê¸°ë¡œ ì„¤ì •
            button = LocationButton(button_text, location, button_width, button_height)

            # ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²°
            button.clicked.connect(lambda checked=False, loc=location: self.on_button_clicked(loc))
            button.pressed.connect(lambda b=button, loc=location: self.on_button_pressed(b, loc))
            button.released.connect(self.on_button_released)

            # ë²„íŠ¼ê³¼ ë°ì´í„° ë§¤í•‘
            self.location_buttons[button] = location

            # ê·¸ë¦¬ë“œì— ì¶”ê°€
            self.grid_layout.addWidget(button, row, col)

        # + ë²„íŠ¼ ìœ„ì¹˜ ê³„ì‚°
        plus_button_pos = len(self.locations)
        
        plus_row = plus_button_pos // max_cols
        plus_col = plus_button_pos % max_cols

        # + ë²„íŠ¼ì„ ë§ˆì§€ë§‰ ìœ„ì¹˜ì— ë°°ì¹˜ (ì»¨í…Œì´ë„ˆ ìœ„ì ¯ì„ ì¶”ê°€)
        self.grid_layout.addWidget(self.plus_button_container, plus_row, plus_col)

    def on_button_pressed(self, button, location):
        self.current_button = button
        self.ignore_next_click = False   # í´ë¦­ ë¬´ì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™”
        self.long_press_timer.start()

    def on_button_released(self):
        if self.long_press_timer.isActive():
            self.long_press_timer.stop()

    def on_long_press(self):
        self.ignore_next_click = True   # ë‹¤ìŒ í´ë¦­ ë¬´ì‹œ í”Œë˜ê·¸ ì„¤ì •
        if self.current_button and self.current_button != self.plus_button:
            location = self.location_buttons.get(self.current_button)
            if location:
                self.edit_location_signal.emit(location)

    def on_button_clicked(self, location):
        # ë¡±í”„ë ˆìŠ¤ í›„ì—ëŠ” í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
        if self.ignore_next_click:
            self.ignore_next_click = False
            return

        self.selected_location = location
        self.location_selected_signal.emit(location)

        # ëª©ì ì§€ ì„ íƒ ë¼ë²¨ì„ ëª©ì ì§€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
        if isinstance(location, dict) and 'name' in location:
            self.title_label.setText(location['name'])
        else:
            self.title_label.setText(str(location))

        # ê¸°ì¡´ì— ì„ íƒëœ ë²„íŠ¼ë“¤ì˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        for button, loc in self.location_buttons.items():
            if button != self.plus_button:  # + ë²„íŠ¼ì€ ì œì™¸
                button.set_selected(False)

        # í˜„ì¬ ì„ íƒëœ ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ ë³€ê²½
        for button, loc in self.location_buttons.items():
            if loc == location:
                button.set_selected(True)
                break

        # ì¶œë°œ ë²„íŠ¼ê³¼ ì‚­ì œ ë²„íŠ¼ í™œì„±í™”
        self.start_button.setEnabled(True)
        self.delete_button.setEnabled(True)

    def on_start_button_clicked(self):
        if self.selected_location:
            self.start_moving_signal.emit(self.selected_location)

    def add_location(self):
        self.add_location_signal.emit()

    def on_delete_button_clicked(self):
        if self.selected_location:
            location_name = self.selected_location.get('name', 'ì„ íƒëœ ëª©ì ì§€')

            # í™•ì¸ ëŒ€í™”ìƒì í‘œì‹œ
            result = MessageBox.show_message(
                self,
                title="ì‚­ì œ í™•ì¸",
                message=f"'{location_name}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                button_labels=["ì˜ˆ", "ì•„ë‹ˆì˜¤"]
            )

            # ì˜ˆ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
            if result == MessageBox.YES:
                self.confirm_delete()

    def confirm_delete(self):
        if self.selected_location:
            self.delete_location_signal.emit(self.selected_location)
            
    def on_change_layout_button_clicked(self):
        """ë ˆì´ì•„ì›ƒ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸"""
        self.change_layout_signal.emit()
            
    def clear_selection(self):
        """ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”"""
        # ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
        self.selected_location = None
        self.start_button.setEnabled(False)
        self.delete_button.setEnabled(False)
        
        # ì œëª© ë¼ë²¨ ì´ˆê¸°í™”
        if not self.locations:
            self.title_label.setText("ëª©ì ì§€ ë“±ë¡")
        else:
            self.title_label.setText("ëª©ì ì§€ ì„ íƒ")
            
        # ëª¨ë“  ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        for button, loc in self.location_buttons.items():
            if button != self.plus_button:  # + ë²„íŠ¼ì€ ì œì™¸
                button.set_selected(False)